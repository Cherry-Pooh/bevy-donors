name: Update Donors

on:
  schedule:
    - cron:  '0 */4 * * *'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  update-donors:
    if: github.repository == 'bevyengine/bevy-donors'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Generate donors.toml and metrics.toml
        env:
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
        run: |
          cargo run
      - name: Tag the repository
        id: tag
        run: |
          # See https://docs.github.com/en/get-started/using-git/dealing-with-special-characters-in-branch-and-tag-names
          TAG=v$(date -Iseconds | sed 's/[T:\+]/-/g')
          echo "$TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          git config user.name "GitHub Action"
          git config user.email "github_action@bevyengine.org"
          git tag -a $TAG -m "Published version $TAG" ${GITHUB_SHA}
          git push origin $TAG
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          files: |
            donors.toml
            metrics.toml
            logos/*
